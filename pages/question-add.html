<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加错题 - 错题本</title>
    
    <!-- Ant Design CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@5.12.8/dist/reset.css">
    
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="../styles.css">
    
    <!-- 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="ant-app">
        <!-- 顶部导航栏 -->
        <header class="ant-header">
            <div class="header-left">
                <div class="app-logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19ZM17 12H7V10H17V12ZM13 16H7V14H13V16ZM17 8H7V6H17V8Z" fill="#1677ff"/>
                    </svg>
                    <span>错题本</span>
                </div>
            </div>
            
            <div class="header-center">
                <button class="ant-btn ant-btn-default" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                    返回错题列表
                </button>
            </div>
            
            <div class="header-right">
                <div class="header-actions">
                    <div class="notification-btn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M10 2C8.5 2 7.5 2.7 7.5 4V5.5C5.5 6.5 4 8.5 4 11V14C4 15.5 5 17 6.5 17H8C8 18.1 8.9 19 10 19C11.1 19 12 18.1 12 17H13.5C15 17 16 15.5 16 14V11C16 8.5 14.5 6.5 12.5 5.5V4C12.5 2.7 11.5 2 10 2ZM10 17C9.4 17 9 16.6 9 16H11C11 16.6 10.6 17 10 17ZM14 14C14 14.6 13.6 15 13 15H7C6.4 15 6 14.6 6 14V11C6 9.3 7.3 8 9 8H11C12.7 8 14 9.3 14 11V14Z" fill="#666"/>
                        </svg>
                        <span class="notification-count">3</span>
                    </div>
                    <div class="user-dropdown">
                        <div class="user-avatar">
                            <img src="https://placehold.co/32x32?text=张" alt="用户头像">
                        </div>
                        <div class="dropdown-menu">
                            <div class="dropdown-item">个人设置</div>
                            <div class="dropdown-item">学习报告</div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item">退出登录</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- 主内容区 -->
        <div class="ant-layout">
            <!-- 内容区域 -->
            <main class="content-area">
                <!-- 添加错题页面 -->
                <div id="question-add" class="ant-page active">
                    <div class="page-header">
                        <h2 class="page-title">添加错题</h2>
                        <div class="page-actions">
                            <button class="ant-btn ant-btn-default" id="cancelBtn">
                                <i class="fas fa-times"></i>
                                取消
                            </button>
                            <button class="ant-btn ant-btn-primary" id="saveBtn">
                                <i class="fas fa-save"></i>
                                保存
                            </button>
                        </div>
                    </div>
                    
                    <div class="question-form-container">
                        <form id="questionForm">
                            <!-- 学科选择 -->
                            <div class="form-group">
                                <label class="form-label">学科 *</label>
                                <select class="ant-select" id="subjectSelect" required>
                                    <option value="">请选择学科</option>
                                    <option value="math">数学</option>
                                    <option value="chinese">语文</option>
                                    <option value="english">英语</option>
                                    <option value="physics">物理</option>
                                    <option value="chemistry">化学</option>
                                </select>
                            </div>
                            
                            <!-- 章节 -->
                            <div class="form-group">
                                <label class="form-label">章节</label>
                                <input type="text" class="ant-input" id="chapterInput" placeholder="请输入章节">
                            </div>
                            
                            <!-- 难度选择 -->
                            <div class="form-group">
                                <label class="form-label">难度 *</label>
                                <select class="ant-select" id="difficultySelect" required>
                                    <option value="">请选择难度</option>
                                    <option value="easy">简单</option>
                                    <option value="medium">中等</option>
                                    <option value="hard">困难</option>
                                </select>
                            </div>
                            
                            <!-- 错题标题 -->
                            <div class="form-group">
                                <label class="form-label">错题标题 *</label>
                                <input type="text" class="ant-input" id="titleInput" placeholder="请输入错题标题" required>
                            </div>
                            
                            <!-- 错题图片上传 -->
                            <div class="form-group">
                                <label class="form-label">错题图片 *</label>
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                        <p>点击上传错题图片</p>
                                        <p class="upload-hint">支持 JPG、PNG 格式，大小不超过 5MB</p>
                                    </div>
                                    <input type="file" class="file-input" id="fileInput" accept="image/*">
                                </div>
                                <div class="preview-container" id="previewContainer" style="display: none;">
                                    <img src="" alt="预览图片" class="preview-image" id="previewImage">
                                    <button type="button" class="ant-btn ant-btn-default remove-btn" id="removeBtn">
                                        <i class="fas fa-trash"></i>
                                        删除
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 标签 -->
                            <div class="form-group">
                                <label class="form-label">标签</label>
                                <div class="tag-input-container">
                                    <input type="text" class="ant-input" id="tagInput" placeholder="输入标签，按回车添加">
                                    <div class="tag-list" id="tagList">
                                        <!-- 标签将通过JavaScript动态生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 错题分析 -->
                            <div class="form-group">
                                <label class="form-label">错题分析</label>
                                <textarea class="ant-textarea" id="errorAnalysisTextarea" rows="4" placeholder="请输入错题分析"></textarea>
                            </div>
                            
                            <!-- 正确解法 -->
                            <div class="form-group">
                                <label class="form-label">正确解法</label>
                                <textarea class="ant-textarea" id="correctSolutionTextarea" rows="4" placeholder="请输入正确解法"></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- 遮罩层 -->
    <div class="overlay" id="overlay"></div>
    
    <script src="../script.js"></script>
    <script>
        // 添加错题页面的交互逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 返回按钮
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    window.location.href = '../index.html';
                });
            }
            
            // 取消按钮
            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    if (confirm('确定要取消添加错题吗？')) {
                        window.location.href = '../index.html';
                    }
                });
            }
            
            // 保存按钮
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    // 验证表单
                    if (validateForm()) {
                        // 保存错题
                        saveQuestion();
                    }
                });
            }
            
            // 图片上传
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const removeBtn = document.getElementById('removeBtn');
            
            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', function() {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // 检查文件大小（不超过5MB）
                        if (file.size > 5 * 1024 * 1024) {
                            alert('文件大小不能超过5MB');
                            return;
                        }
                        
                        // 检查文件类型
                        if (!file.type.startsWith('image/')) {
                            alert('请选择图片文件');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.src = e.target.result;
                            uploadArea.style.display = 'none';
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    fileInput.value = '';
                    previewContainer.style.display = 'none';
                    uploadArea.style.display = 'block';
                });
            }
            
            // 标签输入
            const tagInput = document.getElementById('tagInput');
            const tagList = document.getElementById('tagList');
            const tags = [];
            
            if (tagInput) {
                tagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const tag = tagInput.value.trim();
                        if (tag && !tags.includes(tag)) {
                            // 限制标签数量不超过10个
                            if (tags.length >= 10) {
                                alert('最多只能添加10个标签');
                                return;
                            }
                            
                            // 限制单个标签长度不超过10个字符
                            if (tag.length > 10) {
                                alert('单个标签长度不能超过10个字符');
                                return;
                            }
                            
                            tags.push(tag);
                            renderTags();
                            tagInput.value = '';
                        }
                    }
                });
            }
            
            function renderTags() {
                tagList.innerHTML = '';
                tags.forEach((tag, index) => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        ${tag}
                        <span class="tag-remove" data-index="${index}">×</span>
                    `;
                    tagList.appendChild(tagElement);
                });
                
                // 添加删除事件
                document.querySelectorAll('.tag-remove').forEach(removeBtn => {
                    removeBtn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        tags.splice(index, 1);
                        renderTags();
                    });
                });
            }
            
            // 表单验证
            function validateForm() {
                const subject = document.getElementById('subjectSelect').value;
                const difficulty = document.getElementById('difficultySelect').value;
                const title = document.getElementById('titleInput').value.trim();
                const hasImage = fileInput.value || (previewImage && previewImage.src);
                
                if (!subject) {
                    alert('请选择学科');
                    return false;
                }
                
                if (!difficulty) {
                    alert('请选择难度');
                    return false;
                }
                
                if (!title) {
                    alert('请输入错题标题');
                    return false;
                }
                
                // 限制标题长度
                if (title.length > 50) {
                    alert('错题标题长度不能超过50个字符');
                    return false;
                }
                
                if (!hasImage) {
                    alert('请上传错题图片');
                    return false;
                }
                
                // 验证章节长度
                const chapter = document.getElementById('chapterInput').value.trim();
                if (chapter.length > 30) {
                    alert('章节名称长度不能超过30个字符');
                    return false;
                }
                
                return true;
            }
            
            // 保存错题
            function saveQuestion() {
                // 获取表单数据
                const subject = document.getElementById('subjectSelect').value;
                const chapter = document.getElementById('chapterInput').value.trim();
                const difficulty = document.getElementById('difficultySelect').value;
                const title = document.getElementById('titleInput').value.trim();
                const errorAnalysis = document.getElementById('errorAnalysisTextarea').value.trim();
                const correctSolution = document.getElementById('correctSolutionTextarea').value.trim();
                
                // 构造错题对象
                const question = {
                    subject: subject,
                    chapter: chapter,
                    difficulty: difficulty,
                    title: title,
                    imageUrl: previewImage.src,
                    tags: [...tags],
                    errorAnalysis: errorAnalysis,
                    correctSolution: correctSolution,
                    // 其他字段使用默认值
                    id: Date.now(), // 临时ID
                    masteryLevel: 0,
                    reviewCount: 0,
                    addDate: new Date(),
                    lastReviewDate: null,
                    nextReviewDate: new Date(Date.now() + 24 * 60 * 60 * 1000), // 默认明天复习
                    reviewStatus: 'upcoming',
                    ebbinghausDays: 1
                };
                
                // 这里应该调用后端API保存错题
                // 模拟保存过程
                console.log('保存错题:', question);
                alert('错题保存成功！');
                window.location.href = '../index.html';
            }
        });
    </script>
</body>
</html>